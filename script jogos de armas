-- ESP Script com Aim Assist ULTRA FORTE - ATIVA AO ATIRAR (CORRIGIDO)
-- Criado para Roblox

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local ContextActionService = game:GetService("ContextActionService")

-- Vari√°veis globais
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

-- Configura√ß√µes
local ESP = {
    Enabled = false,
    TeamCheck = false,
    MaxDistance = 3000,
    BoxColor = Color3.fromRGB(255, 0, 0),
    TextColor = Color3.fromRGB(255, 255, 255),
    TextSize = 14
}

-- Configura√ß√µes do Aim Assist
local AimAssist = {
    Enabled = false,
    AlwaysOn = false,
    ShootToActivate = true,
    TeamCheck = true,
    Smoothness = 0.95,
    SnapSmoothness = 0.99,
    FOV = 1000,
    MaxDistance = 2000,
    TargetPart = "Head",
    WallCheck = false,
    MagnetMode = false,
    LockTarget = false
}

-- Vari√°veis de controle
local ESPObjects = {}
local CurrentTarget = nil
local LockedTarget = nil
local FOV_Circle = nil
local Connection = nil
local IsShooting = false
local LastClickTime = 0
local IsPanelVisible = true
local IsDraggingSlider = false

-- Atualizar refer√™ncias
local function UpdateReferences()
    LocalPlayer = Players.LocalPlayer
    if LocalPlayer then
        Mouse = LocalPlayer:GetMouse()
    end
    Camera = Workspace.CurrentCamera
end

-- Criar ESP
local function CreateESP(player)
    if player == LocalPlayer then return end
    if ESPObjects[player] then RemoveESP(player) end
    
    local drawings = {}
    
    drawings.Box = Drawing.new("Square")
    drawings.Box.Visible = false
    drawings.Box.Color = ESP.BoxColor
    drawings.Box.Thickness = 2
    drawings.Box.Filled = false
    drawings.Box.Transparency = 1
    
    drawings.Name = Drawing.new("Text")
    drawings.Name.Visible = false
    drawings.Name.Color = ESP.TextColor
    drawings.Name.Size = ESP.TextSize
    drawings.Name.Center = true
    drawings.Name.Outline = true
    drawings.Name.OutlineColor = Color3.fromRGB(0, 0, 0)
    
    drawings.Distance = Drawing.new("Text")
    drawings.Distance.Visible = false
    drawings.Distance.Color = ESP.TextColor
    drawings.Distance.Size = ESP.TextSize - 2
    drawings.Distance.Center = true
    drawings.Distance.Outline = true
    drawings.Distance.OutlineColor = Color3.fromRGB(0, 0, 0)
    
    drawings.Line = Drawing.new("Line")
    drawings.Line.Visible = false
    drawings.Line.Color = Color3.fromRGB(255, 0, 0)
    drawings.Line.Thickness = 2
    
    ESPObjects[player] = drawings
end

local function RemoveESP(player)
    if ESPObjects[player] then
        for _, drawing in pairs(ESPObjects[player]) do
            if drawing then drawing:Remove() end
        end
        ESPObjects[player] = nil
    end
end

local function IsVisible(targetPosition)
    if not AimAssist.WallCheck then return true end
    if not LocalPlayer.Character then return false end
    
    local origin = Camera.CFrame.Position
    local direction = (targetPosition - origin).Unit * (targetPosition - origin).Magnitude
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {LocalPlayer.Character}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    
    local result = Workspace:Raycast(origin, direction, raycastParams)
    return result == nil
end

local function GetClosestPlayer()
    if not LocalPlayer.Character then return nil end
    local myHumanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
    local myRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not myHumanoid or not myRoot or myHumanoid.Health <= 0 then return nil end
    
    local closestPlayer = nil
    local shortestDistance = AimAssist.FOV
    local centerScreen = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    
    if AimAssist.LockTarget and LockedTarget and LockedTarget.Character then
        local targetPart = LockedTarget.Character:FindFirstChild(AimAssist.TargetPart)
        local humanoid = LockedTarget.Character:FindFirstChild("Humanoid")
        if targetPart and humanoid and humanoid.Health > 0 then
            local screenPos, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
            if onScreen then return LockedTarget end
        end
        LockedTarget = nil
    end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if AimAssist.TeamCheck and player.Team == LocalPlayer.Team then continue end
        
        local character = player.Character
        if not character then continue end
        
        local humanoid = character:FindFirstChild("Humanoid")
        local targetPart = character:FindFirstChild(AimAssist.TargetPart)
        
        if not humanoid or not targetPart or humanoid.Health <= 0 then continue end
        
        local distance = (myRoot.Position - targetPart.Position).Magnitude
        if distance > AimAssist.MaxDistance then continue end
        
        local screenPos, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
        if not onScreen then continue end
        
        if not IsVisible(targetPart.Position) then continue end
        
        local screenDistance = (Vector2.new(screenPos.X, screenPos.Y) - centerScreen).Magnitude
        if screenDistance < shortestDistance then
            shortestDistance = screenDistance
            closestPlayer = player
        end
    end
    
    if AimAssist.LockTarget and closestPlayer then
        LockedTarget = closestPlayer
    end
    
    return closestPlayer
end

local function ApplyAimAssist()
    UpdateReferences()
    
    local shouldApply = AimAssist.AlwaysOn or (AimAssist.Enabled and (not AimAssist.ShootToActivate or IsShooting))
    
    if not shouldApply then 
        CurrentTarget = nil
        return 
    end
    
    if not LocalPlayer.Character then return end
    local myHumanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
    if not myHumanoid or myHumanoid.Health <= 0 then return end
    
    CurrentTarget = GetClosestPlayer()
    
    if CurrentTarget and CurrentTarget.Character then
        local targetPart = CurrentTarget.Character:FindFirstChild(AimAssist.TargetPart)
        if targetPart then
            local targetPos = targetPart.Position
            if AimAssist.TargetPart == "Head" then
                targetPos = targetPos + Vector3.new(0, 0.2, 0)
            end
            
            local cameraCF = Camera.CFrame
            local targetCF = CFrame.new(cameraCF.Position, targetPos)
            
            local screenPos = Camera:WorldToViewportPoint(targetPos)
            local centerScreen = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
            local distanceFromCenter = (Vector2.new(screenPos.X, screenPos.Y) - centerScreen).Magnitude
            
            local smoothValue
            if distanceFromCenter < 30 then
                smoothValue = AimAssist.SnapSmoothness
            elseif distanceFromCenter < 100 then
                smoothValue = 0.95
            elseif AimAssist.MagnetMode then
                smoothValue = 0.9
            else
                smoothValue = AimAssist.Smoothness
            end
            
            Camera.CFrame = cameraCF:Lerp(targetCF, smoothValue)
        end
    else
        LockedTarget = nil
    end
end

local function UpdateESP()
    UpdateReferences()
    
    if not LocalPlayer.Character then return end
    local myRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not myRoot then return end
    
    local centerScreen = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    
    if FOV_Circle then
        local showCircle = AimAssist.AlwaysOn or (AimAssist.Enabled and (IsShooting or not AimAssist.ShootToActivate))
        FOV_Circle.Visible = showCircle
        FOV_Circle.Position = centerScreen
        FOV_Circle.Radius = AimAssist.FOV
        
        if CurrentTarget and IsShooting then
            FOV_Circle.Color = Color3.fromRGB(255, 0, 0)
            FOV_Circle.Thickness = 3
        elseif CurrentTarget then
            FOV_Circle.Color = Color3.fromRGB(255, 255, 0)
            FOV_Circle.Thickness = 2
        else
            FOV_Circle.Color = Color3.fromRGB(100, 100, 100)
            FOV_Circle.Thickness = 1
        end
    end
    
    for player, drawings in pairs(ESPObjects) do
        if not ESP.Enabled then
            for _, d in pairs(drawings) do d.Visible = false end
            continue
        end
        
        local character = player.Character
        if not character then
            for _, d in pairs(drawings) do d.Visible = false end
            continue
        end
        
        local humanoid = character:FindFirstChild("Humanoid")
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        
        if not humanoid or not rootPart or humanoid.Health <= 0 then
            for _, d in pairs(drawings) do d.Visible = false end
            continue
        end
        
        if ESP.TeamCheck and player.Team == LocalPlayer.Team then
            for _, d in pairs(drawings) do d.Visible = false end
            continue
        end
        
        local rootPosition, onScreen = Camera:WorldToViewportPoint(rootPart.Position)
        local distance = (myRoot.Position - rootPart.Position).Magnitude
        
        if not onScreen or distance > ESP.MaxDistance then
            for _, d in pairs(drawings) do d.Visible = false end
            continue
        end
        
        local size = math.clamp(2000 / rootPosition.Z, 10, 200)
        local width = size * 0.6
        local height = size * 1.2
        
        drawings.Box.Size = Vector2.new(width, height)
        drawings.Box.Position = Vector2.new(rootPosition.X - width/2, rootPosition.Y - height/2)
        drawings.Box.Visible = true
        
        if player == CurrentTarget then
            if IsShooting then
                drawings.Box.Color = Color3.fromRGB(255, 0, 0)
                drawings.Box.Thickness = 5
            else
                drawings.Box.Color = AimAssist.MagnetMode and Color3.fromRGB(255, 0, 255) or Color3.fromRGB(255, 255, 0)
                drawings.Box.Thickness = 3
            end
            drawings.Box.Filled = true
            drawings.Box.Transparency = 0.3
            
            drawings.Line.From = centerScreen
            drawings.Line.To = Vector2.new(rootPosition.X, rootPosition.Y)
            drawings.Line.Visible = true
            drawings.Line.Color = IsShooting and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(255, 255, 0)
        else
            drawings.Box.Color = ESP.BoxColor
            drawings.Box.Thickness = 2
            drawings.Box.Filled = false
            drawings.Line.Visible = false
        end
        
        drawings.Name.Text = player.Name .. (player == CurrentTarget and (IsShooting and " [FIRING]" or " [TARGET]") or "")
        drawings.Name.Position = Vector2.new(rootPosition.X, rootPosition.Y - height/2 - 15)
        drawings.Name.Visible = true
        drawings.Name.Color = (player == CurrentTarget) and (IsShooting and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(255, 255, 0)) or ESP.TextColor
        drawings.Name.Size = (player == CurrentTarget) and 16 or ESP.TextSize
        
        drawings.Distance.Text = math.floor(distance) .. "m"
        drawings.Distance.Position = Vector2.new(rootPosition.X, rootPosition.Y + height/2 + 5)
        drawings.Distance.Visible = true
    end
end

-- Interface
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ESPMenu"
ScreenGui.Parent = game.CoreGui
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 260, 0, 540) -- Aumentado para caber o slider
MainFrame.Position = UDim2.new(0, 20, 0, 20)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

-- T√≠tulo
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 35)
Title.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
Title.BorderSizePixel = 0
Title.Text = "üî• AIM ASSIST ULTRA üî•"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 18
Title.Font = Enum.Font.GothamBold
Title.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 8)
TitleCorner.Parent = Title

-- Fun√ß√£o bot√£o
local function CreateButton(name, posY, color, textSize)
    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(0.9, 0, 0, 28)
    Button.Position = UDim2.new(0.05, 0, 0, posY)
    Button.BackgroundColor3 = color or Color3.fromRGB(70, 70, 70)
    Button.BorderSizePixel = 0
    Button.Text = name .. ": OFF"
    Button.TextColor3 = Color3.fromRGB(255, 255, 255)
    Button.TextSize = textSize or 11
    Button.Font = Enum.Font.GothamBold
    Button.Parent = MainFrame
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 6)
    Corner.Parent = Button
    
    return Button
end

-- Bot√µes
local ToggleESP = CreateButton("ESP", 40, Color3.fromRGB(200, 50, 50))
local ToggleAim = CreateButton("AIM ASSIST", 72, Color3.fromRGB(200, 50, 50), 12)
local ToggleShootMode = CreateButton("ON SHOOT ONLY", 104, Color3.fromRGB(0, 100, 200))
local ToggleMagnet = CreateButton("MAGNET MODE", 136, Color3.fromRGB(150, 0, 150))
local ToggleLock = CreateButton("LOCK TARGET", 168, Color3.fromRGB(100, 100, 0))
local ToggleTeamESP = CreateButton("Team Check ESP", 200, Color3.fromRGB(70, 70, 70))
local ToggleTeamAim = CreateButton("Team Check Aim", 232, Color3.fromRGB(50, 150, 50))
local ToggleWallCheck = CreateButton("Wall Check", 264, Color3.fromRGB(70, 70, 70))

-- Bot√£o para esconder/mostrar painel
local TogglePanel = CreateButton("HIDE PANEL", 296, Color3.fromRGB(100, 100, 100))
TogglePanel.Text = "HIDE PANEL üëÅÔ∏è"

-- NOVO: Container do Slider de FOV
local SliderContainer = Instance.new("Frame")
SliderContainer.Size = UDim2.new(0.9, 0, 0, 50)
SliderContainer.Position = UDim2.new(0.05, 0, 0, 328)
SliderContainer.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
SliderContainer.BorderSizePixel = 0
SliderContainer.Parent = MainFrame

local SliderCorner = Instance.new("UICorner")
SliderCorner.CornerRadius = UDim.new(0, 6)
SliderCorner.Parent = SliderContainer

-- Label do FOV com valor atual
local FOVLabel = Instance.new("TextLabel")
FOVLabel.Size = UDim2.new(1, 0, 0, 20)
FOVLabel.Position = UDim2.new(0, 0, 0, 5)
FOVLabel.BackgroundTransparency = 1
FOVLabel.Text = "FOV: 1000"
FOVLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
FOVLabel.TextSize = 12
FOVLabel.Font = Enum.Font.GothamBold
FOVLabel.Parent = SliderContainer

-- Barra de fundo do slider
local SliderBG = Instance.new("Frame")
SliderBG.Size = UDim2.new(0.9, 0, 0, 8)
SliderBG.Position = UDim2.new(0.05, 0, 0, 28)
SliderBG.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
SliderBG.BorderSizePixel = 0
SliderBG.Parent = SliderContainer

local SliderBGCorner = Instance.new("UICorner")
SliderBGCorner.CornerRadius = UDim.new(0, 4)
SliderBGCorner.Parent = SliderBG

-- Barra de preenchimento (vermelha)
local SliderFill = Instance.new("Frame")
SliderFill.Size = UDim2.new(0.5, 0, 1, 0) -- Come√ßa no meio (1000/2000)
SliderFill.Position = UDim2.new(0, 0, 0, 0)
SliderFill.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
SliderFill.BorderSizePixel = 0
SliderFill.Parent = SliderBG

local SliderFillCorner = Instance.new("UICorner")
SliderFillCorner.CornerRadius = UDim.new(0, 4)
SliderFillCorner.Parent = SliderFill

-- Bot√£o arrast√°vel do slider
local SliderKnob = Instance.new("TextButton")
SliderKnob.Size = UDim2.new(0, 16, 0, 16)
SliderKnob.Position = UDim2.new(0.5, -8, 0.5, -8)
SliderKnob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
SliderKnob.BorderSizePixel = 0
SliderKnob.Text = ""
SliderKnob.Parent = SliderBG

local SliderKnobCorner = Instance.new("UICorner")
SliderKnobCorner.CornerRadius = UDim.new(1, 0) -- C√≠rculo
SliderKnobCorner.Parent = SliderKnob

-- Labels min/max
local MinLabel = Instance.new("TextLabel")
MinLabel.Size = UDim2.new(0, 30, 0, 15)
MinLabel.Position = UDim2.new(0.05, 0, 0, 38)
MinLabel.BackgroundTransparency = 1
MinLabel.Text = "10"
MinLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
MinLabel.TextSize = 9
MinLabel.Font = Enum.Font.Gotham
MinLabel.Parent = SliderContainer

local MaxLabel = Instance.new("TextLabel")
MaxLabel.Size = UDim2.new(0, 30, 0, 15)
MaxLabel.Position = UDim2.new(0.85, 0, 0, 38)
MaxLabel.BackgroundTransparency = 1
MaxLabel.Text = "1500"
MaxLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
MaxLabel.TextSize = 9
MaxLabel.Font = Enum.Font.Gotham
MaxLabel.Parent = SliderContainer

-- Status label (reposicionado)
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(0.9, 0, 0, 20)
StatusLabel.Position = UDim2.new(0.05, 0, 0, 382)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Status: Esperando tiro..."
StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
StatusLabel.TextSize = 10
StatusLabel.Font = Enum.Font.GothamBold
StatusLabel.Parent = MainFrame

-- Label modo (reposicionado)
local ModeLabel = Instance.new("TextLabel")
ModeLabel.Size = UDim2.new(0.9, 0, 0, 30)
ModeLabel.Position = UDim2.new(0.05, 0, 0, 405)
ModeLabel.BackgroundTransparency = 1
ModeLabel.Text = "MODO: Clique esquerdo para ativar aim"
ModeLabel.TextColor3 = Color3.fromRGB(0, 200, 255)
ModeLabel.TextSize = 10
ModeLabel.Font = Enum.Font.Gotham
ModeLabel.TextWrapped = true
ModeLabel.Parent = MainFrame

-- Aviso (reposicionado)
local WarningLabel = Instance.new("TextLabel")
WarningLabel.Size = UDim2.new(0.9, 0, 0, 25)
WarningLabel.Position = UDim2.new(0.05, 0, 0, 505)
WarningLabel.BackgroundTransparency = 1
WarningLabel.Text = "‚ö†Ô∏è ULTRA FORTE | Smooth: 0.95"
WarningLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
WarningLabel.TextSize = 10
WarningLabel.Font = Enum.Font.Gotham
WarningLabel.Parent = MainFrame

-- Fun√ß√£o para atualizar o slider
local function UpdateSlider(input)
    local sliderBG = SliderBG
    local relativeX = math.clamp((input.Position.X - sliderBG.AbsolutePosition.X) / sliderBG.AbsoluteSize.X, 0, 1)
    
    -- Mapear 0-1 para 10-1500
    local minFOV = 10
    local maxFOV = 1500
    local newFOV = math.floor(minFOV + (relativeX * (maxFOV - minFOV)))
    
    -- Atualizar valor
    AimAssist.FOV = newFOV
    
    -- Atualizar visual
    SliderFill.Size = UDim2.new(relativeX, 0, 1, 0)
    SliderKnob.Position = UDim2.new(relativeX, -8, 0.5, -8)
    FOVLabel.Text = "FOV: " .. tostring(newFOV) .. (newFOV >= 1400 and " (MAX)" or newFOV <= 20 and " (MIN)" or "")
    
    -- Atualizar c√≠rculo de FOV se existir
    if FOV_Circle then
        FOV_Circle.Radius = newFOV
    end
end

-- Eventos do slider
SliderKnob.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        IsDraggingSlider = true
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if IsDraggingSlider and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        UpdateSlider(input)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        IsDraggingSlider = false
    end
end)

-- Clique na barra para pular direto
SliderBG.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        UpdateSlider(input)
    end
end)

-- Fun√ß√µes bot√µes
ToggleESP.MouseButton1Click:Connect(function()
    ESP.Enabled = not ESP.Enabled
    ToggleESP.Text = "ESP: " .. (ESP.Enabled and "ON" or "OFF")
    ToggleESP.BackgroundColor3 = ESP.Enabled and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
end)

ToggleAim.MouseButton1Click:Connect(function()
    AimAssist.Enabled = not AimAssist.Enabled
    ToggleAim.Text = "AIM ASSIST: " .. (AimAssist.Enabled and "ON üî•" or "OFF")
    ToggleAim.BackgroundColor3 = AimAssist.Enabled and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(200, 50, 50)
    
    if AimAssist.Enabled then
        Title.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        wait(0.2)
        Title.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
    end
end)

ToggleShootMode.MouseButton1Click:Connect(function()
    AimAssist.ShootToActivate = not AimAssist.ShootToActivate
    if AimAssist.ShootToActivate then
        ToggleShootMode.Text = "ON SHOOT ONLY: ON üéØ"
        ToggleShootMode.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        ModeLabel.Text = "MODO: Clique esquerdo para ativar aim"
        ModeLabel.TextColor3 = Color3.fromRGB(0, 255, 100)
    else
        ToggleShootMode.Text = "ALWAYS ON: ON ‚ö°"
        ToggleShootMode.BackgroundColor3 = Color3.from
